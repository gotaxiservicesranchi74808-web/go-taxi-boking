<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO TAXI SERVICES â€“ Booking View</title>
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
h2{color:#1e88e5;text-align:center}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;box-shadow:0 0 5px rgba(0,0,0,.1)}
.btn{padding:8px 12px;background:#1e88e5;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-right:5px;margin-top:5px}
.btn:hover{background:#1565c0}
small{color:#555}
</style>
</head>
<body>

<h2>ðŸ“‹ Bookings</h2>
<div id="list">Loadingâ€¦</div>

<script>
const driverMobile = localStorage.getItem("driverMobile"); // Driver mobile from login
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz8KlhAXfQiAPqnvad-vNgtnD_SM4CEbZudneBRCDmoF8v3tPvTvvDwGCGXQzDw7nkiEw/exec";

fetch(SCRIPT_URL)
.then(r => r.json())
.then(result => {
  const bookings = result.data;
  console.log("Driver Mobile:", driverMobile);
  console.log("All Bookings:", bookings);

  if (!Array.isArray(bookings) || bookings.length === 0) {
    document.getElementById("list").innerHTML = "<b>No Booking Found</b>";
    return;
  }

  let filteredBookings = bookings;

  // Driver login filter
  if(driverMobile){
    filteredBookings = bookings.filter(b =>
      String(b.Assigned_Driver_Mobile || "").trim() === driverMobile.trim()
    );
  }

  console.log("Filtered Bookings:", filteredBookings);

  let html = "";
  if(filteredBookings.length === 0){
    html = "<b>No assigned bookings</b>";
  } else {
    filteredBookings.reverse().forEach(b => {
      html += `
      <div class="card">
        <b>Trip ID:</b> ${b.tripId || b.Booking_ID || "-"}<br>
        <b>Trip:</b> ${b.tripType || "-"}<br>
        <b>Date:</b> ${formatDate(b.pickupDate)}<br>
        <b>Time:</b> ${b.pickupTime || "-"}<br><br>

        <b>Customer:</b> ${b.customerName || "-"} (${b.customerPhone || "-"})<br>
        <b>Driver:</b> ${b.driverName || "-"} (${b.driverPhone || "-"})<br><br>

        <b>Route:</b><br>
        ${b.pickup || "-"} â†’ ${b.goingOn || "-"} â†’ ${b.drop || "-"}<br><br>

        <b>Cab:</b> ${b.cabType || "-"}<br>
        <b>Cab No:</b> ${b.cabNo || "-"}<br><br>

        <b>Total:</b> â‚¹${b.totalAmount || "-"} |
        <b>Advance:</b> â‚¹${b.advance || 0} |
        <b>Balance:</b> â‚¹${b.balance || "-"}<br>
        <b>Driver Collection:</b> â‚¹${b.driverCollection || "-"}<br><br>

        ${driverMobile ? `<button class="btn" onclick='startTrip(${JSON.stringify(b)})'>Start Trip</button>` : ""}
      </div>`;
    });
  }

  document.getElementById("list").innerHTML = html;

})
.catch(err=>{
  console.error("Error loading data:", err);
  document.getElementById("list").innerHTML="<b>Error loading data</b>";
});

function formatDate(d){
  if(!d) return "";
  return new Date(d).toLocaleDateString("en-IN");
}

function startTrip(b){
  localStorage.setItem("activeBooking", JSON.stringify(b));
  window.location.href="trip-start.html";
}
</script>

</body>
</html>
