<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GO TAXI SERVICES â€“ Driver Bookings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
h2{color:#1e88e5;text-align:center}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;box-shadow:0 0 5px rgba(0,0,0,.1)}
.btn{padding:8px 12px;background:#1e88e5;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-right:5px;margin-top:5px}
.btn:hover{background:#1565c0}
input{width:70px;margin-right:5px}
small{color:#555}
</style>
</head>
<body>

<h2>ðŸ“‹ My Assigned Bookings</h2>
<div id="list">Loadingâ€¦</div>

<script>
const driverMobile = (localStorage.getItem("driverMobile") || "").trim();
if(!driverMobile){
  alert("Please login first");
  window.location.href="index.html"; // driver login page
}

// Apps Script URL
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyEeaghZPF4SAdulfT1ATBPV9I46-5Aet4rhZhpvScqJNHtCoebxGkXRz93RbkToyCPxQ/exec";

// Fetch bookings
fetch(SCRIPT_URL)
.then(r => r.json())
.then(result => {
  const bookings = result.data || [];

  // Filter driver bookings with Trip_Status = "Assigned"
  const filtered = bookings.filter(b=>{
    const sheetMobile = String(b.Assigned_Driver_Mobile || "").trim();
    const status = String(b.Trip_Status || "").trim();
    return sheetMobile === driverMobile && status.toLowerCase() === "assigned";
  });

  let html = "";
  if(filtered.length === 0){
    html="<b>No assigned bookings</b>";
  } else {
    filtered.reverse().forEach(b=>{
      html += `
      <div class="card">
        <b>Trip ID:</b> ${b.tripId || b.Booking_ID}<br>
        <b>Trip:</b> ${b.tripType || "-"}<br>
        <b>Date:</b> ${formatDate(b.pickupDate)}<br>
        <b>Time:</b> ${b.pickupTime || "-"}<br><br>

        <b>Customer:</b> ${b.customerName || "-"} (${b.customerPhone || "-"})<br>
        <b>Route:</b><br>
        ${b.pickup} â†’ ${b.goingOn || "-"} â†’ ${b.drop}<br><br>

        <b>Cab:</b> ${b.cabType || "-"} | <b>No:</b> ${b.cabNo || "-"}<br><br>

        <b>Start Meter:</b> <input type="number" id="startMeter-${b.tripId}" value="${b.Start_Meter||''}">
        <button class="btn" onclick="startTrip('${b.tripId}')">Start Trip</button><br><br>

        <b>End Meter:</b> <input type="number" id="endMeter-${b.tripId}" value="${b.End_Meter||''}">
        <b>Collection:</b> <input type="number" id="collection-${b.tripId}" value="${b.Collection||''}">
        <button class="btn" onclick="endTrip('${b.tripId}')">End & Submit</button>
      </div>
      `;
    });
  }

  document.getElementById("list").innerHTML = html;

}).catch(err=>{
  console.error("Error loading data:", err);
  document.getElementById("list").innerHTML="<b>Error loading data</b>";
});

function formatDate(d){
  if(!d) return "";
  return new Date(d).toLocaleDateString("en-IN");
}

// Start trip - save start meter
function startTrip(tripId){
  const val = document.getElementById(`startMeter-${tripId}`).value;
  if(!val) { alert("Enter start meter reading"); return; }
  alert(`Trip ${tripId} started at meter ${val}`);
  // Optionally, update in Sheet via POST later
}

// End trip - save end meter and collection
function endTrip(tripId){
  const end = document.getElementById(`endMeter-${tripId}`).value;
  const col = document.getElementById(`collection-${tripId}`).value;
  if(!end || !col){ alert("Enter End meter and Collection"); return; }
  alert(`Trip ${tripId} ended at meter ${end}. Collection â‚¹${col}`);
  // Optionally, send POST request to save in Sheet
}
</script>

</body>
</html>
