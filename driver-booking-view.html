<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Driver App – GO TAXI SERVICES</title>
<style>
body{font-family:Arial;background:#f4f6f8;padding:15px}
.card{background:#fff;padding:15px;margin-bottom:15px;border-radius:8px;box-shadow:0 0 5px rgba(0,0,0,.1)}
input,button{padding:8px;margin-top:8px;width:100%}
button{background:#1e88e5;color:#fff;border:none;border-radius:5px}
</style>
</head>

<body>

<h2>My Bookings</h2>
<div id="bookingList">Loading...</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyEeaghZPF4SAdulfT1ATBPV9I46-5Aet4rhZhpvScqJNHtCoebxGkXRz93RbkToyCPxQ/exec";
const driverMobile = localStorage.getItem("driverMobile");

if(!driverMobile){
  alert("Please login first");
  window.location.href="index.html";
}

fetch(API_URL)
.then(res => res.json())
.then(json => {
  const bookings = json.data || [];
  const list = document.getElementById("bookingList");
  list.innerHTML = "";

  const myBookings = bookings.filter(b =>
    String(b.Assigned_Driver_Mobile).trim() === driverMobile &&
    String(b.Trip_Status).trim() !== "COMPLETED"
  );

  if(myBookings.length === 0){
    list.innerHTML = "<b>No booking found</b>";
    return;
  }

  myBookings.forEach(b => {
    const div = document.createElement("div");
    div.className = "card";

    if(b.Trip_Status === "RUNNING"){
      div.innerHTML = `
        <b>${b.tripId}</b><br>
        ${b.pickup} → ${b.drop}<br><br>
        <input id="end_${b.tripId}" placeholder="End Meter">
        <input id="col_${b.tripId}" placeholder="Collection Amount">
        <button onclick="closeTrip('${b.tripId}')">Close Trip</button>
      `;
    } else {
      div.innerHTML = `
        <b>${b.tripId}</b><br>
        ${b.pickup} → ${b.drop}<br><br>
        <input id="start_${b.tripId}" placeholder="Start Meter">
        <button onclick="startTrip('${b.tripId}')">Start Trip</button>
      `;
    }

    list.appendChild(div);
  });
});

function startTrip(tripId){
  const meter = document.getElementById("start_"+tripId).value;
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({ action:"START", tripId, meter })
  }).then(()=>location.reload());
}

function closeTrip(tripId){
  const meter = document.getElementById("end_"+tripId).value;
  const collection = document.getElementById("col_"+tripId).value;
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({ action:"CLOSE", tripId, meter, collection })
  }).then(()=>location.reload());
}
</script>

</body>
</html>
